name: Build mesa-git

on:
  push:
    paths:
      - '.github/workflows/amd-mesa.yml'
  workflow_dispatch:

jobs:
  build-and-package-mesa:
    runs-on: ubuntu-latest

    container:
      image: archlinux:base

    steps:
    - name: Update system and install build dependencies
      run: |
        pacman -Syu --noconfirm
        pacman -S --noconfirm git base-devel

    - name: Clone repo for PKGBUILD
      run: |
         git clone https://github.com/buildingpkgs/mg.git

    - name: Build Mesa
      run: |
        sed -i 's/^#MAKEFLAGS/MAKEFLAGS/' /etc/makepkg.conf

        cd /__w/mg/mg/mg/.github/workflows/
        su user -c "makepkg -si --noconfirm"

    - name: Create artifact
      uses: actions/upload-artifact@v3.1.2
      with:
        name: mesa-llvm
        path: |
            mesa-git/*.zst
            
